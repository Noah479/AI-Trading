1. ## 基本信息

   - **Base URL**：`http://127.0.0.1:5001`（启动日志和 `app.run(..., port=5001)`）。
   - **认证**：无（本地 Mock 服务，不校验前端请求头）。
   - **返回格式**：JSON（业务接口），HTML（页面路由）。
   - **默认交易对集合**（行情接口会返回这些标的）：
      `["BTC-USDT","ETH-USDT","BNB-USDT","SOL-USDT","XRP-USDT","DOGE-USDT"]`。
   - **缓存说明**（供前端理解数据刷新节奏）：
     - 行情快照（`price/last/high24h/low24h`）缓存 **2 秒**；
     - K 线（candles）缓存 **10 分钟**；
     - K 线长度默认 **240 根**；
     - 周期包含 **30m** 与 **4h**。
   - **K 线数据结构**：`[open, high, low, close, volume]`（从旧到新，已为正序）。

   ------

   ## 目录

   1. [GET `/ai/status` — AI 状态 JSON](#get-aistatus)
   2. [GET `/market` — 市场快照与多周期 K 线](#get-market)
   3. [GET `/recent/signals` — 最近信号（JSONL 汇总）](#get-recentsignals)
   4. [GET `/recent/trades` — 最近交易（JSONL 汇总）](#get-recenttrades)
   5. [GET `/logs/` — 直接读取日志文件](#get-logsfilename)
   6. [GET `/balance` — 账户权益 + 未实现盈亏聚合](#get-balance)
   7. [POST `/order` — 模拟下单](#post-order)
   8. [GET `/verify` — 连通性/Key 校验（OKX Demo）](#get-verify)
   9. [GET `/dashboard` — 仪表盘页面（HTML）](#get-dashboard)
   10. [GET `/ai` — AI 状态页面（HTML）](#get-ai)

   ------

   ### GET `/ai/status`

   返回 AI 引擎/策略运行状态（从 `logs/ai_status.json` 读取）。

   - **Query**：无

   - **响应**：

     - 文件存在：返回其 JSON 内容；
     - 文件不存在：`{"status":"empty","message":"ai_status.json not found"}`（**仍为 200**）；
     - 异常：`{"status":"error","error":"..."}`（**500**）。

   - **示例**

     ```
     curl -s http://127.0.0.1:5001/ai/status
     ```

   ------

   ### GET `/market`

   返回所有内置交易对的**最新价 + 24h 高低 + 多周期 K 线**。

   - **Query**：无

   - **响应结构**：

     ```
     {
       "data": {
         "BTC-USDT": {
           "price":  68000.1,
           "last":   68000.1,
           "high24h": 70000.0,
           "low24h":  66000.0,
           "candles": {
             "30m": [[o,h,l,c,v], ...],   // 正序（旧->新）
             "4h":  [[o,h,l,c,v], ...]
           }
         },
         "...": { ... }
       }
     }
     ```

     - K 线数组元素是 `[open, high, low, close, volume]`。
     - 周期包含 `30m`、`4h`（见 BARS）。

   - **示例**

     ```
     curl -s http://127.0.0.1:5001/market
     ```

   ------

   ### GET `/recent/signals`

   返回最近的信号记录。底层读取 `logs/recent_signals.jsonl` 的**最后 N 行**并**倒序（新→旧）**输出。

   - **Query**

     - `limit`（可选，默认 `50`）：返回最近 N 条。

   - **响应**

     ```
     {"items":[ {...}, {...}, ... ]}
     ```

     > 说明：内部利用 `_tail_jsonl()` 先截取末尾 N 行，再反转为**最新在前**。

   - **示例**

     ```
     curl -s "http://127.0.0.1:5001/recent/signals?limit=20"
     ```

   ------

   ### GET `/recent/trades`

   返回最近的交易记录。读取 `logs/recent_trades.jsonl` 的**最后 N 行**并**倒序（新→旧）**输出。

   - **Query**

     - `limit`（可选，默认 `50`）。

   - **响应**

     ```
     {"items":[ {...}, {...}, ... ]}
     ```

     > 同样通过 `_tail_jsonl()` 实现尾部截取 + 反转输出。

   - **示例**

     ```
     curl -s "http://127.0.0.1:5001/recent/trades?limit=20"
     ```

   ------

   ### GET `/logs/<filename>`

   从服务端 `logs/` 目录**直接回传指定文件**（如 `.jsonl`、`.csv` 等），**原样输出**（不是 JSON API）。

   - **Path Param**

     - `<filename>`：例如 `recent_trades.jsonl`、`ai_status.json`。

   - **响应**：文件原始内容（`send_from_directory`）。

   - **前端建议**：

     - JSONL 文件需使用 `text.splitlines()`，逐行 `JSON.parse`。

   - **示例**

     ```
     curl -s http://127.0.0.1:5001/logs/recent_trades.jsonl | head
     ```

   ------

   ### GET `/balance`

   **聚合账户权益**与**未实现盈亏**：从 OKX `/account/balance` 与 `/account/positions` 读取，计算 `totalEq_incl_unrealized = totalEq + Σupl`。

   - **Query**：无

   - **响应（成功 200）**：

     ```
     {
       "code": "0",
       "msg": "success",
       "totalEq": 12345.67,
       "unrealizedPnL": 12.34,
       "totalEq_incl_unrealized": 12358.01,
       "details": [ ... ]   // OKX 原始 details 透传
     }
     ```

     > 异常时：`{"error":"..."}`，**500**。

   - **示例**

     ```
     curl -s http://127.0.0.1:5001/balance
     ```

   ------

   ### POST `/order`

   **模拟下单**（不真正访问 OKX，下发一个 `MOCK-<timestamp>` 的订单号用于联调链路）。

   - **Headers**：`Content-Type: application/json`

   - **Body(JSON)**（示例与默认值）：

     ```
     {
       "symbol": "BTC-USDT",
       "side": "buy",          // buy / sell（不区分大小写）
       "size": 0.001,
       "order_type": "market"  // 可选，默认 "market"
     }
     ```

   - **响应（成功 200）**：

     ```
     {
       "code": "0",
       "msg": "success",
       "data": [{
         "orderId": "MOCK-1761658136",
         "instId": "BTC-USDT",
         "side": "buy",
         "sz": "0.001",
         "ordType": "market"
       }]
     }
     ```

     > 控制台会打印 `[MOCK ORDER] BUY 0.001 BTC-USDT`，便于本地排查。

   - **示例**

     ```
     curl -s -X POST http://127.0.0.1:5001/order \
       -H "Content-Type: application/json" \
       -d '{"symbol":"BTC-USDT","side":"buy","size":0.001}'
     ```

   ------

   ### GET `/verify`

   **连通性/Key 校验**：访问 OKX 余额接口，若返回 `code="0"` 则判定连接成功（环境为 `Simulated (Demo Trading)`）。失败时返回 400，异常返回 500。

   - **Query**：无

   - **响应（成功 200）**：

     ```
     {
       "status": "success",
       "environment": "Simulated (Demo Trading)",
       "total_equity_usd": "12345.67",
       "keys_valid": true,
       "message": "Connection successful ✅"
     }
     ```

     - 失败（Key 无效等）：`{"status":"failed","keys_valid":false,"error":{...}}`（**400**）；
     - 异常：`{"status":"error","error":"..."}`（**500**）。

   - **示例**

     ```
     curl -s http://127.0.0.1:5001/verify
     ```

   ------

   ### GET `/dashboard`

   返回仪表盘 **HTML 页面**（模板渲染）。前端直接以页面方式访问，不是 JSON。

   ```
   curl -s http://127.0.0.1:5001/dashboard
   ```

   ------

   ### GET `/ai`

   返回 AI 状态 **HTML 页面**（模板渲染）。前端直接以页面方式访问，不是 JSON。

   ```
   curl -s http://127.0.0.1:5001/ai
   ```

   ------

   ## 前端对接建议

   - **轮询/订阅**：
     - 实时状态：`/ai/status`（每 1–3 秒）；
     - 行情：`/market`（快照 2s 缓存、K 线 10min 缓存，建议 2–5 秒轮询一次快照即可）。
   - **历史明细**：
     - 轻量预览：`/recent/*`；
     - 全量日志下载/回放：`/logs/*.jsonl`（前端自行逐行解析）。
   - **下单链路联调**：
     - 使用 `POST /order` 模拟下单，不涉及真实资金。
   - **健康检查**：
     - 用 `GET /verify` 做启动自检。

   ------

   > 备注：源码中**未定义** `/api/status` 路由，AI 状态 JSON 的**实际**接口为 `/ai/status`（与测试结果一致）。如需统一前缀，可在后端新增别名或改路由后再更新本文档。
   
## 注意事项

1. **模拟交易模式**：当前 `/order` 接口为模拟模式，不会真实下单
2. **API 频率限制**：已实现缓存机制，避免触发 OKX 频率限制
3. **日志持久化**：所有信号和交易会记录到 JSONL 文件
4. **时区**：所有时间戳使用 UTC 时间
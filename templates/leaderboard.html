<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Decision Leaderboard • OKX Mock</title>
  <style>
    :root{
      --bg:#0f1115;
      --panel:#141821;
      --grid:#202633;
      --grid-2:#2a3142;
      --ink:#eaeef7;
      --muted:#9aa4b2;
      --accent:#6ae3ff;
      --warning:#ffd166;
      --success:#4cd97b;
      --danger:#ff6b6b;
      --border:2px;
      --radius:10px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:radial-gradient(1200px 800px at 20% -10%, #1b2230 0, #0f1115 60%, #0c0f14 100%);
      color:var(--ink);
      font: 15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .container{
      max-width:1200px;
      margin:32px auto 80px auto;
      padding:0 20px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      gap:12px;
    }
    header h1{
      font-size:20px;
      letter-spacing:.04em;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chip{
      font-size:12px;
      padding:4px 8px;
      border:1px solid var(--grid-2);
      background:linear-gradient(180deg, #1a2130, #151b27);
      border-radius:8px;
      color:var(--muted);
    }
    .controls{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    button, .btn{
      background:#182030;
      color:#eaeef7;
      border:1px solid #2a3241;
      border-radius:8px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.02em;
    }
    button:hover{border-color:#3e4a61}
    .btn-ghost{
      background:transparent;
      color:var(--muted);
    }
    .metrics{
      display:grid;
      grid-template-columns: repeat(9, 1fr);
      gap:0;
      border:var(--border) solid #000;
      border-radius: var(--radius);
      overflow:hidden;
      background: repeating-linear-gradient( 0deg, #182031, #182031 1px, #171e2b 1px, #171e2b 22px );
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .cell{
      border-right:var(--border) solid #000;
      border-bottom:var(--border) solid #000;
      padding:10px 12px;
      min-height:58px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .cell:last-child{border-right:none;}
    .label{
      font-size:11px; text-transform:uppercase; color:#c6cfdd; letter-spacing:.08em;
    }
    .value{
      font-variant-numeric: tabular-nums;
      font-weight:700; font-size:18px;
    }
    .value.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .value.good{color:var(--success)}
    .value.bad{color:var(--danger)}
    .value.warn{color:var(--warning)}
    .panel{
      margin-top:22px;
      background:linear-gradient(180deg, #121826, #101520);
      border:1px solid #1c2432;
      border-radius:12px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
    }
    .panel header{
      padding:12px 16px;
      margin:0;
      background:linear-gradient(180deg, #172033, #131a29);
      border-bottom:1px solid #1e2537;
    }
    .panel header h2{
      font-size:14px; letter-spacing:.06em; text-transform:uppercase; margin:0; color:#cfe0ff;
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed;
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg, #1b2436, #151c2b);
      border-bottom:1px solid #232c3f;
      font-size:12px; text-transform:uppercase; letter-spacing:.06em;
      color:#c6cfdd;
      padding:10px 8px;
    }
    tbody td{
      border-bottom:1px dashed #1e2535;
      padding:10px 8px;
      vertical-align:top;
      color:#dbe3f4;
    }
    tbody tr:hover{ background: rgba(106,227,255,.05); }
    .kpi{display:flex; align-items:center; gap:8px;}
    .sub{color:var(--muted); font-size:12px;}
    .pill{padding:2px 6px; border-radius:999px; font-size:12px; border:1px solid #2a3347; background:#141c2a; color:#cfe0ff;}
    .side-buy{ color: #6efacc; }
    .side-sell{ color: #ff8d8d; }
    .truncate{display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient: vertical; overflow:hidden;}
    .right{ text-align:right; }
    .center{ text-align:center; }
    .muted{ color: var(--muted); }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .footnote{ color:#9aa4b2; font-size:12px; margin-top:10px;}
    .status-dot {width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:#777;}
    .status-on {background:#3ad29f;}
    .status-off{background:#e66;}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .search{background:#111826;border:1px solid #253044;border-radius:8px;padding:8px 10px;color:#eaeef7;min-width:220px;}
    .small{font-size:12px;}
    .sticky-actions{ position: sticky; right:0; background: inherit; }
    @media (max-width: 1100px){ .metrics{ grid-template-columns: repeat(3, 1fr);} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>AI Decision Leaderboard <span class="chip" id="serverChip">Server: —</span></h1>
      <div class="controls">
        <input id="search" class="search" placeholder="过滤 Symbol / 方向 / 关键词…" />
        <button id="btnRefresh">手动刷新</button>
        <button id="btnToggleAuto" class="btn-ghost">暂停自动刷新</button>
        <span class="chip small" id="lastUpdate">Last update —</span>
      </div>
    </header>

    <!-- KPI GRID -->
    <section class="metrics" id="kpiGrid" aria-live="polite">
      <!-- 9 cells -->
      <div class="cell"><div class="label">ACCT VALUE ↓</div><div class="value mono" id="kpiEquity">—</div><div class="sub" id="kpiEnv">—</div></div>
      <div class="cell"><div class="label">RETURN %</div><div class="value mono" id="kpiRetPct">—</div><div class="sub" id="kpiRetBase">—</div></div>
      <div class="cell"><div class="label">TOTAL P&L</div><div class="value mono" id="kpiPnL">—</div><div class="sub" id="kpiPnLNote">—</div></div>
      <div class="cell"><div class="label">FEES</div><div class="value mono" id="kpiFees">—</div><div class="sub">Trades-based</div></div>
      <div class="cell"><div class="label">WIN RATE</div><div class="value mono" id="kpiWinRate">—</div><div class="sub" id="kpiWinRateN">—</div></div>
      <div class="cell"><div class="label">BIGGEST WIN</div><div class="value mono good" id="kpiBigWin">—</div><div class="sub">By trade PnL</div></div>
      <div class="cell"><div class="label">BIGGEST LOSS</div><div class="value mono bad" id="kpiBigLoss">—</div><div class="sub">By trade PnL</div></div>
      <div class="cell"><div class="label">SHARPE</div><div class="value mono" id="kpiSharpe">—</div><div class="sub">Based on signals</div></div>
      <div class="cell"><div class="label">TRADES</div><div class="value mono" id="kpiTrades">—</div><div class="sub" id="kpiTradesWindow">—</div></div>
    </section>

    <!-- DECISION FEED -->
    <section class="panel" style="margin-top:22px">
      <header><h2>Decision Feed · 每次 AI 决策详情</h2></header>
      <div style="overflow:auto; max-height: 70vh">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:140px">Time</th>
              <th style="width:110px">Symbol</th>
              <th style="width:80px">Side</th>
              <th style="width:90px" class="right">Size</th>
              <th style="width:110px" class="right">Price</th>
              <th style="width:90px" class="right">Equity</th>
              <th style="width:80px" class="right">Conf</th>
              <th>Reason</th>
              <th style="width:100px" class="right sticky-actions">Est. PnL</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="9" class="center muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="footnote">
        注：Sharpe 与 Return% 基于 <code>/recent/signals</code> 账户价值序列估算；若缺失字段则会自动降级。交易费与胜率基于 <code>/recent/trades</code> 日志中可用字段（例如 <code>fee</code>、<code>pnl</code>）。
      </div>
    </section>
  </div>

<script>
const AUTO_REFRESH_MS = 5000;
const BASE_URL = (window.LEADERBOARD_BASE_URL) || "http://127.0.0.1:5001";
const EP = {
  ai:       BASE_URL + "/api/status",
  market:   BASE_URL + "/market",
  signals:  BASE_URL + "/recent/signals?limit=240",
  trades:   BASE_URL + "/recent/trades?limit=240",
  balance:  BASE_URL + "/balance",
  verify:   BASE_URL + "/verify"
};

// ===== Utils =====
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const fmtUSD = (n)=> (isFinite(n)? (n<0? "-" : "") + "$" + Math.abs(n).toLocaleString(undefined,{maximumFractionDigits:2}) : "—");
const fmtPct = (x)=> (isFinite(x)? ((x>=0? "+" : "") + (x*100).toFixed(2) + "%") : "—");
const fmtPctPlain = (x)=> (isFinite(x)? (x*100).toFixed(2) + "%" : "—");
const fmtNum = (n, d=4)=> (isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:d}) : "—");
const toDate = (ts)=> {
  if (!ts) return null;
  try { return new Date(ts); } catch(e){ return null; }
}
const tsStr = (ts)=>{
  const d = toDate(ts);
  if(!d) return "—";
  const pad=(n)=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
};
const sum = (arr)=> arr.reduce((a,b)=> a + (isFinite(b)? +b : 0), 0);
const mean = (arr)=> arr.length? sum(arr)/arr.length : 0;
const stdev = (arr)=>{
  if(arr.length<2) return 0;
  const m = mean(arr);
  const v = mean(arr.map(x => (x-m)**2));
  return Math.sqrt(v);
};

async function jget(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function pick(obj, path, dflt=undefined){
  try{
    return path.split('.').reduce((o,k)=> (o && k in o)? o[k] : undefined, obj) ?? dflt;
  }catch(_){ return dflt; }
}

function computeSharpeFromSignals(signals){
  // Returns based on account_value; per-step sharpe (not annualized)
  const vals = (signals||[]).map(s=> Number(s.account_value ?? s.account?.equity)).filter(v=> isFinite(v) && v>0);
  if(vals.length<3) return null;
  const rets = [];
  for (let i=1;i<vals.length;i++){
    const r = (vals[i] - vals[i-1]) / vals[i-1];
    if (isFinite(r)) rets.push(r);
  }
  if(rets.length<2) return null;
  const m = mean(rets);
  const sd = stdev(rets);
  if(sd===0) return null;
  // show step Sharpe and a "×√N" note is omitted to avoid assuming sampling freq
  return m/sd;
}

function aggregateTrades(trades){
  let n=0, wins=0, losses=0, totalFees=0, pnlList=[];
  (trades||[]).forEach(t=>{
    // Allow various keys
    const fee = Number(t.fee ?? t.fees ?? t.commission ?? 0);
    if (isFinite(fee)) totalFees += fee;
    let pnl = t.pnl ?? t.PnL ?? t.profit ?? t.realized_pnl ?? null;
    if (pnl!=null) {
      pnl = Number(pnl);
      if (isFinite(pnl)){
        pnlList.push(pnl);
        n++;
        if(pnl>0) wins++; else if(pnl<0) losses++;
      }
    }
  });
  const winRate = (n>0)? wins/n : null;
  const biggestWin = pnlList.length? Math.max(...pnlList) : null;
  const biggestLoss = pnlList.length? Math.min(...pnlList) : null;
  return { totalFees, winRate, biggestWin, biggestLoss, nWithPnL:n, totalTrades:(trades||[]).length };
}

function deriveBaseline(signals){
  if(!signals || !signals.length) return null;
  const oldest = signals[signals.length-1];
  const v = Number(oldest.account_value ?? oldest.account?.equity);
  return isFinite(v) ? v : null;
}

function renderKPIs({equity, env, base, totalPnL, retPct, fees, winRate, nWinBase, bigWin, bigLoss, sharpe, tradesN, windowStr}){
  $("#kpiEquity").textContent  = fmtUSD(equity);
  $("#kpiEnv").textContent     = env || "—";
  $("#kpiRetPct").textContent  = isFinite(retPct)? fmtPctPlain(retPct) : "—";
  $("#kpiRetBase").textContent = base? "Base " + fmtUSD(base) : "Base —";
  $("#kpiPnL").textContent     = isFinite(totalPnL)? fmtUSD(totalPnL) : "—";
  $("#kpiPnLNote").textContent = base? "Current − Base" : "—";
  $("#kpiFees").textContent    = isFinite(fees)? fmtUSD(fees) : "—";
  $("#kpiWinRate").textContent = (winRate==null? "—" : fmtPctPlain(winRate));
  $("#kpiWinRateN").textContent= (nWinBase? `on ${nWinBase} PnL trades` : "—");
  $("#kpiBigWin").textContent  = isFinite(bigWin)? fmtUSD(bigWin) : "—";
  $("#kpiBigLoss").textContent = isFinite(bigLoss)? fmtUSD(bigLoss) : "—";
  $("#kpiSharpe").textContent  = (sharpe==null? "—" : sharpe.toFixed(2));
  $("#kpiTrades").textContent  = tradesN ?? "—";
  $("#kpiTradesWindow").textContent = windowStr || "—";
}

function renderDecisions(signals, market){
  const tbody = $("#tbody");
  tbody.innerHTML = "";
  if(!signals || !signals.length){
    tbody.innerHTML = `<tr><td colspan="9" class="center muted">暂无数据</td></tr>`;
    return;
  }
  const lastMap = {};
  if (market && market.data){
    Object.keys(market.data).forEach(sym=> lastMap[sym] = Number(market.data[sym]?.last));
  }
  const rows = signals.map(s => {
    const ts = s.ts ?? s.timestamp ?? s.time ?? s.created_at;
    const sym = s.symbol ?? (s.coin? `${s.coin}-USDT`: "—");
    const side = String((s.side ?? s.action ?? s.signal ?? "")).toLowerCase();
    const size = Number(s.size ?? s.position_size ?? s.qty ?? s.quantity);
    const conf = Number(s.confidence ?? s.conf ?? NaN);
    const reason = s.reason ?? s.decision_reason ?? s.comment ?? s.ai_reason ?? "";
    const eq = Number(s.account_value ?? s.account?.equity);
    const price = lastMap[sym] ?? Number(s.price ?? s.last);
    // naive est pnl: show dash; real pnl should come from fills
    const est = null;
    return {ts, sym, side, size, conf, reason, eq, price, est};
  });

  const frag = document.createDocumentFragment();
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="muted small">${tsStr(r.ts)}</td>
      <td><span class="pill">${r.sym}</span></td>
      <td class="${r.side==='buy'?'side-buy':(r.side==='sell'?'side-sell':'muted')}">${r.side? r.side.toUpperCase() : "—"}</td>
      <td class="right">${isFinite(r.size)? fmtNum(r.size,6) : "—"}</td>
      <td class="right">${isFinite(r.price)? fmtNum(r.price,4) : "—"}</td>
      <td class="right">${isFinite(r.eq)? fmtNum(r.eq,2) : "—"}</td>
      <td class="right">${isFinite(r.conf)? fmtNum(r.conf,2) : "—"}</td>
      <td><div class="truncate">${r.reason || "—"}</div></td>
      <td class="right sticky-actions">${isFinite(r.est)? fmtUSD(r.est) : "—"}</td>
    `;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

function filterTable(keyword){
  const kw = keyword.trim().toLowerCase();
  $$("#tbody tr").forEach(tr => {
    if(!kw){ tr.style.display=""; return; }
    const txt = tr.textContent.toLowerCase();
    tr.style.display = txt.includes(kw) ? "" : "none";
  });
}

let autoTimer = null;
async function refreshAll(){
  try{
    $("#serverChip").innerHTML = `<span class="status-dot status-on"></span>${BASE_URL}`;
    const [ai, mkt, sig, trd, bal, ver] = await Promise.all([
      jget(EP.ai).catch(_=>({})),
      jget(EP.market).catch(_=>({})),
      jget(EP.signals).catch(_=>({items:[]})),
      jget(EP.trades).catch(_=>({items:[]})),
      jget(EP.balance).catch(_=>({})),
      jget(EP.verify).catch(_=>({}))
    ]);

    const signals = sig.items || [];
    const trades = trd.items || [];
    const equity = Number(bal.totalEq_incl_unrealized ?? (bal.totalEq ?? pick(ai,"account.equity")));
    const env = ver.environment || "—";
    const base = deriveBaseline(signals);
    const totalPnL = (isFinite(equity) && isFinite(base)) ? (equity - base) : null;
    const retPct = (isFinite(equity) && isFinite(base) && base>0) ? (equity/base - 1) : null;
    const { totalFees, winRate, biggestWin, biggestLoss, nWithPnL, totalTrades } = aggregateTrades(trades);
    const sharpe = computeSharpeFromSignals(signals);
    const winStrN = nWithPnL || 0;
    renderKPIs({
      equity, env, base, totalPnL, retPct,
      fees: totalFees, winRate, nWinBase: winStrN,
      bigWin: biggestWin, bigLoss: biggestLoss,
      sharpe, tradesN: totalTrades, windowStr: `${signals.length} signals / ${trades.length} trades window`
    });
    renderDecisions(signals, mkt);
    $("#lastUpdate").textContent = "Last update " + new Date().toLocaleTimeString();
  }catch(e){
    console.error(e);
    $("#serverChip").innerHTML = `<span class="status-dot status-off"></span>${BASE_URL}`;
  }
}

function startAuto(){
  if(autoTimer) return;
  autoTimer = setInterval(refreshAll, AUTO_REFRESH_MS);
}
function stopAuto(){
  if(!autoTimer) return;
  clearInterval(autoTimer); autoTimer=null;
}

document.addEventListener("DOMContentLoaded", () => {
  refreshAll(); startAuto();
  $("#btnRefresh").addEventListener("click", refreshAll);
  const btn = $("#btnToggleAuto");
  btn.addEventListener("click", () => {
    if(autoTimer){ stopAuto(); btn.textContent="恢复自动刷新"; }
    else { startAuto(); btn.textContent="暂停自动刷新"; }
  });
  $("#search").addEventListener("input", (e)=> filterTable(e.target.value));
});
</script>
</body>
</html>

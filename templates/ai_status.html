<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI 实时状态 · Alpha Arena</title>
  <style>
    :root { --bg:#0b1020; --panel:#12182a; --muted:#8aa0c5; --accent:#5ae0a3; --danger:#ff6b6b; --warn:#ffd166;}
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:#dfe7ff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--panel);border:1px solid #1d2742;border-radius:12px;padding:16px}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    h1{margin:0 0 12px;font-size:20px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-weight:700}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px}
    .pill.on{background:rgba(90,224,163,0.12);color:var(--accent);border:1px solid rgba(90,224,163,0.35)}
    .pill.off{background:rgba(255,107,107,0.12);color:var(--danger);border:1px solid rgba(255,107,107,0.35)}
    .pill.warn{background:rgba(255,209,102,0.12);color:var(--warn);border:1px solid rgba(255,209,102,0.35)}
    .muted{color:var(--muted)}
    .bar{height:10px;background:#1e2741;border-radius:6px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#4fc3f7,#5ae0a3)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #222d4a;font-size:12px;text-align:left}
    .right{text-align:right}
    .btn{background:#223055;border:1px solid #2d3e66;color:#dfe7ff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    @media(max-width:980px){.col-4,.col-6,.col-8,.col-12{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="grid">
    <div class="col-12"><h1>AI 实时状态 · Alpha Arena <span class="k" id="updatedAt"></span></h1></div>

    <!-- 顶部概览 -->
    <div class="card col-4">
      <div class="row"><div class="k">引擎模式</div><div id="engineMode" class="pill on">TEST_MODE</div></div>
      <div class="row"><div class="k">调用次数</div><div class="v" id="invocations">-</div></div>
      <div class="row"><div class="k">账户权益</div><div class="v" id="equity">-</div></div>
    </div>

    <div class="card col-4">
      <div class="row"><div class="k">最近决策</div><div class="v" id="decisionMain">-</div></div>
      <div class="row"><div class="k">信心(0~1)</div><div class="v" id="decisionConf">-</div></div>
      <div class="row"><div class="k">跟踪标的</div><div class="v" id="mkSymbol">-</div></div>
    </div>

    <div class="card col-4">
      <div class="row"><div class="k">24h 波动率</div><div class="v" id="mkVol">-</div></div>
      <div class="row"><div class="k">全局冷却模式</div><div class="v" id="cdMode">-</div></div>
      <div class="row"><div class="k">冷却剩余</div><div class="v" id="cdRemain">-</div></div>
      <div class="bar" title="冷却进度（剩余/总时长）"><i id="cdBar" style="width:0%"></i></div>
    </div>

    <!-- 灰度智能解锁 -->
    <div class="card col-12">
      <div class="row">
        <div><div class="k">灰度智能解锁（仅提示，不执行）</div></div>
        <div>
          <button class="btn" onclick="fetchStatus(true)">手动刷新</button>
        </div>
      </div>
      <div class="row">
        <div id="unlockPill" class="pill off">不建议提前解锁</div>
        <div class="muted" id="unlockReason">-</div>
      </div>
      <div class="mono" id="rawJson" style="white-space:pre;overflow:auto;max-height:260px;margin-top:8px;"></div>
    </div>

    <!-- 最近信号/成交（可选：调用后端已有接口） -->
    <div class="card col-6">
      <div class="row"><div class="k">Recent Signals</div></div>
      <table class="table" id="signalsTable">
        <thead><tr><th>时间</th><th>币种</th><th>信号</th><th class="right">数量</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card col-6">
      <div class="row"><div class="k">Recent Trades</div></div>
      <table class="table" id="tradesTable">
        <thead><tr><th>时间</th><th>币种</th><th>方向</th><th class="right">数量</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const fmtUsd = v => (v==null?'-':Number(v).toLocaleString(undefined,{maximumFractionDigits:2}));
    const fmtPct = v => (v==null?'-':(Number(v)*100).toFixed(2)+'%');
    const el = id => document.getElementById(id);

    async function fetchJson(url){
      const r = await fetch(url, {cache:'no-cache'});
      return await r.json();
    }

    function setPill(id, on, text, level){
      const p = el(id);
      p.className = 'pill ' + (on ? (level==='strong'?'on':'warn') : 'off');
      p.textContent = text;
    }

    function setBar(id, remain, total){
      const b = el(id);
      if(!total || total<=0){ b.style.width='0%'; return; }
      const pct = Math.max(0, Math.min(100, (remain/total)*100));
      b.style.width = pct.toFixed(1)+'%';
    }

    function fillTable(id, items, map){
      const tb = document.querySelector('#'+id+' tbody');
      tb.innerHTML = (items||[]).map(map).join('') || '<tr><td colspan="4" class="muted">无数据</td></tr>';
    }

    async function fetchSignals(){
      const data = await fetchJson('/recent/signals?limit=10').catch(()=>({items:[]}));
      fillTable('signalsTable', data.items, x =>
        `<tr><td>${x.ts||'-'}</td><td>${x.coin||'-'}</td><td>${x.signal||'-'}</td><td class="right">${x.quantity??'-'}</td></tr>`
      );
    }

    async function fetchTrades(){
      const data = await fetchJson('/recent/trades?limit=10').catch(()=>({items:[]}));
      fillTable('tradesTable', data.items, x =>
        `<tr><td>${x.ts||'-'}</td><td>${x.symbol||x.coin||'-'}</td><td>${x.side||'-'}</td><td class="right">${x.size??'-'}</td></tr>`
      );
    }

    async function fetchStatus(force=false){
      const s = await fetchJson('/ai/status').catch(()=>({status:'error'}));
      if(!s || s.status==='empty'){
        el('updatedAt').textContent = ' · 等待引擎写入状态...';
        return;
      }
      el('updatedAt').textContent = ' · 更新于 ' + (new Date(s.updated_at)).toLocaleString();
      el('engineMode').textContent = s.engine?.test_mode ? 'TEST_MODE' : 'LIVE_MODE';
      el('invocations').textContent = s.engine?.invocations ?? '-';
      el('equity').textContent = '$' + fmtUsd(s.account?.equity);

      const d = s.decision||{};
      el('decisionMain').textContent = d.symbol ? `${d.side||'-'}  ${d.symbol}` : '—';
      el('decisionConf').textContent = d.confidence==null ? '-' : (Number(d.confidence).toFixed(2));
      el('mkSymbol').textContent = s.market?.symbol || '-';
      el('mkVol').textContent = s.market?.volatility_24h_pct==null ? '-' : fmtPct(s.market.volatility_24h_pct);

      const cd = s.risk?.cooldown || {};
      el('cdMode').textContent = cd.mode || '-';
      el('cdRemain').textContent = `${cd.remaining_seconds??0}s / ${cd.cooldown_seconds??0}s`;
      setBar('cdBar', cd.remaining_seconds||0, cd.cooldown_seconds||0);

      const gu = s.gray_unlock || {suggested:false};
      setPill('unlockPill', gu.suggested, gu.suggested ? (gu.level==='strong'?'强烈建议提前解锁':'建议提前解锁') : '不建议提前解锁', gu.level);
      el('unlockReason').textContent = gu.reason || '-';

      // 原始 JSON 展示
      el('rawJson').textContent = JSON.stringify(s, null, 2);

      // 同步最近信号/成交
      if(force){ await Promise.all([fetchSignals(), fetchTrades()]); }
    }

    // 首次加载与定时刷新
    (async () => {
      await fetchStatus(true);
      await fetchSignals();
      await fetchTrades();
      setInterval(fetchStatus, 3000);
      setInterval(fetchSignals, 5000);
      setInterval(fetchTrades, 5000);
    })();
  </script>
</body>
</html>
